# История изменений

##### build_iso_images.sh

v2.210823
- Добавлены формирование в спец.файл '.sha1' и проверка контрольных сумм для базовых образов

v2.210716
- Добавлено формирование контрольной суммы готового ISO-образа в спец.файл '.sha1'
- Теперь выводится предупреждение, если опция командной строки не поддерживается командой
  (Теперь имена сборок не должны начинаться с символа '-')

v2.210616
- Специальный файл `.build_version` теперь дублируется в корневую файловую систему
- Теперь во внутренних сообщениях об ошибках указывается возникла ошибка в основном скрипте или его форке
  (при использовании механизма `subshell` при подстановке значений)

v2.210505
- Вывод команды `ls` теперь можно фильтровать, указав в качестве параметров имена сборок
  настройки которых только и надо отобразить
- Теперь очередность сборок при команде 'build' повторяет очередность указания их в командной строке,
  а не в конфигурационном файле, как было ранее

v2.210427
- Теперь пропускаем сборку если скрипт деплоя не был найден (ранее просто игнорировалось)
- Добавлена запись в ISO-образ специального файла `.build_version` с параметрами сборки

v2.210426
- Добавлена возможность указания команд необходимых для сборки базового слоя в специальном файле
  `.dependencies` вместо добавления такой проверки в скрипты `.build.sh` и `.pre_images.sh`
- Мелкие улучшения в информационных сообщениях

v2.210422
- Добавлена поддержка **шаблонов**: теперь скрипт умеет собирать любое множество ISO-образов,
  каждый из которых состоит из базового слоя и `git`-репозитария со скриптами деплоя,
  а их конфигурация теперь описывается в конфигурационном файле
- Реализовано кеширование артефактов базовых слоёв, пересборка их вызывается автоматически
  при изменении любого файла в папке базового слоя (`base_layers/`)
- Подготовлен базовый слой `xenial-amd64-minbase`
- Добавлен команда 'ls' для отображения настроек конфигурационного файла
- Скрипт переименован из `build_ubuntu_livecd` в `build_iso_images`, т.к. теперь скрипт не привязан
  к конкретному дистрибутиву и может собирать ISO-образы для любой операционной системы

v1.210326
- Добавлена установка временной зоны через `guestinfo.timezone` параметр

v1.210322
- Добавлен `sysctl`-параметр `kernel.panic` для автоматической перезагрузки виртуальной машины

v1.210318
- Исправлена ошибка с невозможность корректного выключения виртуальной машины из-за сообщения:
  `Please remove the installation medium, then press Enter:`

v1.210316
- Добавлена поддержка распаковки .tgz архивов из provision_files/
- Добавлена поддержка установки hostname виртуальной машины из `guestinfo.hostname` параметра
- Сетевые настройки теперь также передаются через `guestinfo` параметры, а не MAC-адрес
- Теперь по умолчанию используется `8.8.8.8` в качестве DNS сервера

##### control_vm_esxi.sh

v3.??????
- Исправлен парсинг не полных UUID в списке файловых систем на гипервизоре
  (возникает, например, при монтировании NFS-каталога)

v3.210823
- Добавлена команда `reboot` для перезагрузки виртуальных машин, в том числе и тех, которые не
  указаны в конфигурационном файле (через указание имени гипервизора в виде префикса)
- При смене ISO-образа (через команду `update`) теперь также происходит его извлечение из
  виртуального CD-ROM через запуск команды `eject` в виртуальной машине из гипервизора
  (ранее это операция происходила при старте виртуальной машины, что делало рестарт виртуальной
  машины не работоспособным, т.к. ISO-образ при старте был извлечен из виртуального CD-ROM)
- Загрузка новых ISO-образов на гипервизор теперь сначала происходит во временный файл, чтобы
  избежать ситуаций получения неработоспособных ISO-образов, когда их загрузка была прервана
- Исправлена ошибка в определении статуса питания виртуальной машины, из-за которой виртуальная
  машина считалась выключенной или уничтоженной даже если все 10 попыток ожидания говорили
  об обратном (появилась в v2.210409)
- Исправлен вывод статуса (`ABORTED` вместо `SKIPPED ISO`) для ISO-образов, у которых был
  невозможен парсинг контрольной суммы из .`sha1`-файла (появилась в v3.210716)
- Исправлено определение автостарта виртуальной машины в команде `show` (появилась в v2.210623)
  (теперь будет показывать `no` вместо `NOT FOUND`, когда настройки автостарта не заданы вообще)

v3.210816
- Добавлена команда `destroy` для уничтожения виртуальных машин на гипервизоре, в том числе
  и тех, которые не указаны в конфигурационном файле (через указание имени гипервизора в виде префикса)
- Добавлена опция `fs` для команд `create` и `destroy` для принудительного выключения
  питания виртуальной машины в случае отсутствующего пакета `vmware-tools` на виртуальной машине
- Добавлен автоматизированный механизм удаления ненужных ISO-образов на гипервизоре,
  механизм запускается для команд `create`, `destroy` и `update` (можно отключить опцией `-sr`)
- Исправлена ошибка в определении доступности хоста в команде `create`, из-за которой хост
  всё равно считался доступным, даже после 10 неудачных попыток определения доступности
  (появилась в v2.210331)
- Исправлена ошибка приводящая к игнорированию опции `-i` в командах `create`, `show` и `update`
  (появилась в v2.210528)
- Исправлена ошибка приводящая к невозможности создания или изменения настроек виртуальной машины,
  если был указан абсолютный путь до ISO-образа (появилась в v3.210716)

v3.210716
- Для команд 'create' и 'update' добавлена отдельная фаза предварительного копирования ISO-образов на гипервизоры
  А с помощью новой команды 'upload' можно вызвать эту фазу изолированно
  Добавлена проверка загружаемых ISO-образов по контрольным суммам с возможностью перезаливки
  в случае несовпадения контрольных сумм, а также реализован отдельный вывод статуса
- Добавлена возможность в качестве списка виртуальных машин и гипервизоров указать все
  имеющиеся с помощью специального имени 'all' (сейчас доступно только для команд 'uplaod' и 'ls'),
  соответственно, теперь нельзя использовать 'all' в качестве имени виртуальной машины или гипервизора
- Добавлена типизация 'SKIPPING' сообщений: теперь указывается пропущена виртуальная машина (VM), гипервизор (ESXI) или ISO-образ (ISO)
- Улучшена обработка ошибок при работе с кеш-файлами, а также исправлена ошибка из-за которой
  из списка неудаленных кеш-файлов выводился только первый из них (появилась в v2.210528)
- Исправлено некорректное определение доступности гипервизора в случае, если все данные о нём были
  взяты только из кеша (появилась в v2.210528)
- Теперь выводится предупреждение, если опция командной строки не поддерживается командой,
  соответственно, теперь имена виртуальных машин и гипервизоров не должны начинаться с символа '-'
- Исправлен многократный вывод ошибок при невозможности подключения к гипервизору (появилась в v2.210623)

v2.210623
- Добавлен новый параметр `vm_autostart` для запрета/разрешения автостарта виртуальной машины при перезагрузке гипервизора
- Исправлена опечатка (появилась в v1.210308) приводящая к невозможности переопределения переменной ESXI_CONFIG_PATH

v2.210616
- Добавлена команда `update` для обновления параметров виртуальной машины:
  сейчас поддерживается только `local_iso_path` параметр
- Добавлена поддержка преобразования **uuid** -> **name** для хранилищ (datastores) для случаев, когда
  в `.vmx` файле прописан полный путь до ISO-файла. А в команду `show` добавлено предупреждение для
  параметра `vm_esxi_datastore`, если такое преобразование не удалось

v2.210607
- Добавлен ключ `-sn` для команды `create`, который пропускает проверку сетевых параметров виртуальной машины
  (для случаев когда шлюз по умолчанию находится в другой подсети)

v2.210528
- Добавлен механизм кеширования карты расположения виртуальных машин на гипервизорах,
  для ускорения работы скрипта со множеством гипервизоров
- Добавлена команда `show` для показа различий параметров виртуальных машин между конфигурационным файлом и гипервизором
- Теперь во внутренних сообщениях об ошибках указывается возникла ошибка в основном скрипте или его форке
  (при использовании механизма `subshell` при подстановке значений)
- В команде `ls` исправлен вывод информации о "пустых" (без виртуальных машин) гипервизорах (ошибка появилась в v2.210505)
- В команде `ls` имена параметров теперь полностью идентичны именам в конфигурационном файле

v2.210512
- Добавлена поддержка хуков (добавлен новый параметр `local_hook_path`)
- При уничтожении виртуальной машины теперь также дожидаемся обновления её статуса
  (подобная проверка была для операций power on, power off, power shutdown)

v2.210505
- Вывод команды `ls` теперь можно фильтровать, указав в качестве параметров имена виртуальных машин
  или гипервизоров настройки которых только и надо отобразить
- Для команды `create` в качестве параметров теперь можно указывать не только имена виртуальных машин,
  но и имена гипервизоров, что добавит в список обработки все виртуальные машины находящиеся на указанных гипервизорах;
  Однако теперь имена виртуальных машин и гипервизоров не должны пересекаться в конфигурационном файле
- Теперь очередность создания виртуальных машин при команде 'create' повторяет очередность указания их
  в командной строке, а не в конфигурационном файле, как было ранее

v2.210427
- Добавлен ключ `-f` для команды `create`, который пересоздаёт уже имеющийся на гипервизоре инстанс виртуальной машины

v2.210426
- Исправлена ошибка в парсере не позволяющая указать более 2х DNS-серверов в `vm_dns_servers` параметре

v2.210423
- Добавлен новый параметр виртуальной машины `vm_dns_servers`

v2.210409
- Добавлен вывод статуса обработанных виртуальных машин, вместо списка пропущенных
- Теперь все сообщения о статусах и ошибках выводятся в stderr
  (чтобы с помощью перенаправлений >/dev/null или 2>/dev/null можно было легко отключить лишний вывод)
- Добавлен ключ '-d' для команды 'create', который позволяет уничтожить старый инстанс виртуальной машины на другом гипервизоре

v2.210331
- Теперь при создании виртуальной машины её существование проверяется на всех гипервизорах, а не только
  на котором она будет создаваться (с помощью дополнительного ключа можно вернуть и прежнее поведение)
- Добавлен вывод списка (а не просто количества) пропущенных виртуальных машин при запуске команды 'create'
- Добавлена проверка на совпадение ipv4-адреса с ipv4-шлюзом в конфигурационном файле
- Исправлен дублирующий вывод ошибки при невозможности создания папки на гипервизоре для хранения ISO-образов
- Добавлена проверка дублирующихся определений ресурсов (гипервизоров или виртуальных машин) в конфигурационном файле

v1.210326
- Добавлен новый параметр виртуальной машины `vm_timezone`
- Отключено использование `vmxswap` для виртуальной машины в VMX-шаблоне
- Прекращено использование оператора `+=` для переопределения элементов ассоциативных массивов,
  т.к. в более ранних версиях `BASH`-интепретатора этот оператор не переопределял значение, а добавлял, если элемент
  массива уже существовал (проблема обнаружена в **bash v4.3.46** в составе `Ubuntu 16.04.2 LTS`)
- Прекращено использование `destination` формата (ssh://user@host:port) при вызове `SSH`-клиента
  для совместимости с более ранними версиями **OpenSSH** пакета, где этот формат ещё не поддерживался
  (проблема обнаружена в **openssh v7.2p2** в составе `Ubuntu 16.04.2 LTS`)
- В команду `ls` добавлено отображение параметров `vm_memory_mb` и `vm_vcpus`

v1.210316
- Добавлена установка параметра виртуальной машины `guestinfo.hostname`
- Сетевые настройки теперь также передаются через `guestinfo` параметры, а не MAC-адрес
- Добавлен параметр `StrictHostKeyChecking=no` для ssh
